<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>å¤§å­¦é‡çƒ åµå¯Ÿ V4.2</title>
<style>
  body { font-family: -apple-system, sans-serif; padding: 10px; background: #f4f4f9; color: #333; padding-bottom: 100px; }
  h2, h3 { text-align: center; color: #0056b3; margin: 5px 0 10px; }
  .card { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 15px; position: relative; z-index: 1; }
  .hidden { display: none !important; }
  .row { display: flex; gap: 10px; margin-bottom: 10px; }
  .col { flex: 1; }
  select, input, button { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 1rem; box-sizing: border-box; }
  
  /* ãƒœã‚¿ãƒ³é¡ */
  .btn-group { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; }
  .btn-check { padding: 5px; background: #f8f9fa; border: 1px solid #ccc; border-radius: 6px; text-align: center; cursor: pointer; font-size: 0.85rem; user-select: none; display: flex; align-items: center; justify-content: center; line-height: 1.2; height: 50px; }
  .btn-check.active { background: #007bff; color: white; border-color: #0056b3; }
  .btn-special { background: #e2e6ea; border-color: #adb5bd; font-weight: bold; color: #495057; } 
  .btn-unknown { background: #e0e0e0; color: #555; }
  #submit-btn { background: #28a745; color: white; font-weight: bold; border: none; padding: 15px; font-size: 1.1rem; }
  
  /* UIãƒ‘ãƒ¼ãƒ„ */
  #grid-wrapper { width: 280px; margin: 0 auto; position: relative; }
  #grid-container { display: grid; grid-template-columns: repeat(5, 1fr); gap: 4px; width: 100%; height: 280px; }
  .grid-cell { background: #e0e0e0; border-radius: 4px; }
  .grid-cell.strike-zone { background: #fff; border: 2px solid #999; }
  .grid-cell.selected { background: #ff4444 !important; border-color: #cc0000; }
  #home-plate { width: 140px; height: 0; margin: 5px auto 0; border-top: 40px solid white; border-left: 70px solid transparent; border-right: 70px solid transparent; position: relative; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2)); }
  #home-plate::after { content: "æ•æ‰‹è¦–ç‚¹"; position: absolute; top: -35px; left: -30px; font-size: 0.8rem; color: #333; font-weight: bold; width: 60px; text-align: center; }
  #field-container { width: 300px; height: 250px; margin: 0 auto; position: relative; background: #4caf50; border-radius: 8px; overflow: hidden; cursor: crosshair; border: 2px solid #388e3c; }
  #field-svg { width: 100%; height: 100%; position: absolute; top: 0; left: 0; pointer-events: none; }
  #hit-marker { width: 12px; height: 12px; background: blue; border: 2px solid white; border-radius: 50%; position: absolute; display: none; transform: translate(-50%, -50%); pointer-events: none; }
  
  /* é–²è¦§ãƒ“ãƒ¥ãƒ¼ãƒ¯ãƒ¼ */
  .log-group { border-bottom: 1px solid #ddd; }
  .log-summary { padding: 12px; background: #fff; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
  .log-summary:hover { background: #f9f9f9; }
  .log-summary .batter-name { font-weight: bold; font-size: 1rem; }
  .log-summary .result-badge { font-size: 0.85rem; padding: 3px 8px; border-radius: 10px; background: #eee; color: #333; }
  .log-summary .result-badge.hit { background: #d4edda; color: #155724; }
  .log-summary .result-badge.out { background: #f8d7da; color: #721c24; }
  .log-details { display: none; background: #f1f1f1; padding: 10px; font-size: 0.85rem; border-top: 1px solid #eee; }
  .log-details.open { display: block; }
  .pitch-row { display: flex; justify-content: space-between; padding: 4px 0; border-bottom: 1px solid #e0e0e0; }
  
  /* ãƒ¢ãƒ¼ãƒ€ãƒ«å…±é€š */
  .modal-overlay { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:2000; display:flex; justify-content:center; align-items:center; }
  .modal-box { background:white; padding:20px; border-radius:10px; width:95%; max-width:500px; max-height: 90vh; overflow-y: auto; }
  
  /* ãã®ä»– */
  .switch-field { display: flex; margin-bottom: 10px; overflow: hidden; }
  .switch-field input { position: absolute !important; clip: rect(0, 0, 0, 0); height: 1px; width: 1px; border: 0; overflow: hidden; }
  .switch-field label { background-color: #e4e4e4; color: rgba(0, 0, 0, 0.6); font-size: 14px; line-height: 1; text-align: center; padding: 12px 16px; margin-right: -1px; border: 1px solid rgba(0, 0, 0, 0.2); flex:1; }
  .switch-field input:checked + label { background-color: #007bff; color: white; }
  
  #loading-screen { position: fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:3000; display:flex; justify-content:center; align-items:center; flex-direction:column; }
  .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin-bottom: 10px; }
  @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  #network-status { position: fixed; top: 0; left: 0; width: 100%; background: #ffc107; color: #333; text-align: center; font-size: 0.8rem; padding: 4px; display: none; z-index: 999; }
  .game-item { padding: 10px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
  .btn-resume { padding: 5px 10px; background: #17a2b8; color: white; border: none; border-radius: 4px; font-size: 0.8rem; margin-right: 5px;}
  .btn-delete { padding: 5px 10px; background: #dc3545; color: white; border: none; border-radius: 4px; font-size: 0.8rem; }
  .count-btn { margin-bottom: 8px; background: #f8f9fa; border: 1px solid #ccc; font-weight: bold; text-align: left; padding-left: 20px; width:100%; padding:12px;}
</style>
</head>
<body>

<div id="network-status">æœªé€ä¿¡: <span id="unsent-count">0</span></div>
<div id="loading-screen" style="display:none;"><div class="spinner"></div><div id="loading-text">å‡¦ç†ä¸­...</div></div>

<div id="inning-modal" class="hidden modal-overlay">
  <div class="modal-box" onclick="event.stopPropagation()">
    <h3>ã‚¤ãƒ‹ãƒ³ã‚°ç§»å‹•</h3>
    <div style="display:flex; gap:10px; margin-bottom:15px;">
      <select id="edit-inning-num">
        <option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option>
        <option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option>
      </select>
      <select id="edit-inning-tb" onchange="updateInningModalPlayers()"><option value="è¡¨">è¡¨</option><option value="è£">è£</option></select>
    </div>
    <div style="background:#f9f9f9; padding:10px; border-radius:5px; margin-bottom:15px;">
      <p style="margin:0 0 5px 0; font-size:0.9rem; font-weight:bold;">ã“ã®å ´é¢ã®é¸æ‰‹ (å¿…é ˆ)</p>
      <label style="font-size:0.8rem;">æŠ•æ‰‹ (å®ˆå‚™å´)</label>
      <select id="modal-inning-pitcher" style="margin-bottom:10px;"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
      
      <label style="font-size:0.8rem;">æ‰“è€… (æ”»æ’ƒå´)</label>
      <select id="modal-inning-batter"><option value="">é¸æŠã—ã¦ãã ã•ã„</option></select>
    </div>
    <div style="display:flex; gap:10px;">
      <button onclick="applyInningChange()" style="background:#007bff; color:white;">ç§»å‹•</button>
      <button onclick="document.getElementById('inning-modal').classList.add('hidden')" style="background:#666; color:white;">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
    </div>
  </div>
</div>

<div id="viewer-modal" class="hidden modal-overlay" onclick="document.getElementById('viewer-modal').classList.add('hidden')">
  <div class="modal-box" onclick="event.stopPropagation()" style="background:#f9f9f9; padding:0;">
    <div style="padding:15px; background:white; border-bottom:1px solid #eee;">
      <h3 style="margin:0;">ğŸ“Š è©¦åˆçµŒé</h3>
    </div>
    <div id="viewer-content" style="height:60vh; overflow-y:auto;">èª­ã¿è¾¼ã¿ä¸­...</div>
    <div style="padding:10px; text-align:center;">
      <button onclick="document.getElementById('viewer-modal').classList.add('hidden')" style="background:#666; color:white;">é–‰ã˜ã‚‹</button>
    </div>
  </div>
</div>

<div id="sub-modal" class="hidden modal-overlay" onclick="document.getElementById('sub-modal').classList.add('hidden')">
  <div class="modal-box" onclick="event.stopPropagation()">
    <h3 style="margin-top:0">ğŸ”„ é¸æ‰‹äº¤ä»£</h3>
    <div style="margin-bottom:15px;"><label>ã€å®ˆå‚™ã€‘æŠ•æ‰‹</label><div style="display:flex; gap:5px;"><select id="sub-pitcher-select"></select><button onclick="applyPitcherChange()" style="background:#007bff; color:white; width:auto;">äº¤ä»£</button></div></div>
    <div style="margin-bottom:15px;"><label>ã€æ”»æ’ƒã€‘ä»£æ‰“</label><div style="display:flex; gap:5px;"><select id="sub-batter-select"></select><button onclick="applyBatterChange()" style="background:#d32f2f; color:white; width:auto;">ä»£æ‰“</button></div></div>
    <button onclick="document.getElementById('sub-modal').classList.add('hidden')" style="background:#666; color:white;">é–‰ã˜ã‚‹</button>
  </div>
</div>

<div id="unknown-modal" class="hidden modal-overlay">
  <div class="modal-box" style="background:#f0f8ff;">
    <h3 style="margin-top:0; color:#333;">ğŸ¤” çµæœä¸æ˜æ™‚ã®å‡¦ç†</h3>
    <button class="count-btn" onclick="resolveUnknown('ball')">ãƒœãƒ¼ãƒ« (B+1)</button>
    <button class="count-btn" onclick="resolveUnknown('strike')">ã‚¹ãƒˆãƒ©ã‚¤ã‚¯ (S+1)</button>
    <button class="count-btn" onclick="resolveUnknown('foul')">ãƒ•ã‚¡ãƒ¼ãƒ« (S+1/ãã®ã¾)</button>
    <button class="count-btn" onclick="resolveUnknown('out')">ã‚¢ã‚¦ãƒˆ (æ¬¡æ‰“è€…)</button>
    <button class="count-btn" onclick="resolveUnknown('next')">å‡ºå¡/å¾—ç‚¹ (æ¬¡æ‰“è€…)</button>
    <button class="count-btn" onclick="resolveUnknown('none')" style="background:#ddd;">å¤‰æ›´ãªã—</button>
  </div>
</div>

<div id="dashboard-screen" class="card">
  <h2>âš¾ åµå¯Ÿãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ V4.2</h2>
  <button onclick="showSetup()" style="background:#007bff; color:white; font-weight:bold; margin-bottom:20px; padding:15px;">ï¼‹ æ–°ã—ã„è©¦åˆã‚’ä½œæˆ</button>
  <h3>å±¥æ­´</h3>
  <div style="text-align:center;">
    <button onclick="loadHistory()" style="background:#17a2b8; color:white; width:auto; padding:10px 20px; cursor:pointer;">ğŸ“‚ å±¥æ­´èª­ã¿è¾¼ã¿</button>
    <div id="game-list-container" style="margin-top:15px;"></div>
  </div>
</div>

<div id="setup-screen" class="card hidden">
  <h3>è©¦åˆè¨­å®š</h3>
  <div class="row"><div class="col"><label>è©¦åˆå</label><input type="text" id="input-match-name" placeholder="ä¾‹: ç§‹å­£ãƒªãƒ¼ã‚° vsæ…¶æ‡‰"></div></div>
  <label>å½¢å¼</label>
  <div class="switch-field">
    <input type="radio" id="mode-league" name="match-mode" value="league" checked onchange="toggleMode()">
    <label for="mode-league">ãƒªãƒ¼ã‚°æˆ¦</label>
    <input type="radio" id="mode-practice" name="match-mode" value="practice" onchange="toggleMode()">
    <label for="mode-practice">ç·´ç¿’è©¦åˆ</label>
  </div>
  <div class="row">
    <div class="col"><label>å…ˆæ”»</label><div id="top-selector-area"><select id="team-top" onchange="onTeamSelect('top')"><option value="">é¸æŠ...</option></select></div></div>
    <div class="col"><label>å¾Œæ”»</label><div id="bottom-selector-area"><select id="team-bottom" onchange="onTeamSelect('bottom')"><option value="">é¸æŠ...</option></select></div></div>
  </div>
  <div class="row"><div class="col" id="lineup-top-container"></div><div class="col" id="lineup-bottom-container"></div></div>
  <div class="row"><div class="col"><label>Game ID</label><input type="text" id="input-game-id" readonly style="background:#eee;"></div></div>
  <button onclick="startGame()" style="background:#28a745; color:white;">è©¦åˆé–‹å§‹</button>
  <button onclick="location.reload()" style="background:#6c757d; color:white; margin-top:10px;">æˆ»ã‚‹</button>
</div>

<div id="game-screen" class="hidden">
  <div id="status-bar">
    <div id="status-inning" onclick="openInningModal()" style="cursor:pointer; text-decoration:underline;">1å›è¡¨</div>
    <div>B:<span id="disp-ball">0</span> S:<span id="disp-strike">0</span> O:<span id="disp-out">0</span></div>
  </div>

  <div class="card" style="text-align:center; background:#e3f2fd;">
    <div style="font-size:0.8rem;">ID: <span id="current-game-id"></span></div>
    <div style="font-weight:bold;">æŠ•: <span id="current-pitcher"></span></div>
    <div style="font-size:1.4rem; color:#d32f2f; font-weight:bold;">VS <span id="current-batter"></span></div>
    <button onclick="openSubModal()" style="margin-top:5px; padding:6px; background:white; color:#333; border:1px solid #ccc; font-size:0.8rem; width:auto;">ğŸ”„ é¸æ‰‹äº¤ä»£</button>
  </div>

  <div class="card">
    <div id="grid-wrapper">
      <div id="grid-container"></div>
      <div id="home-plate"></div>
    </div>
    <div style="text-align:center; margin-top:5px;">
        <button class="btn-unknown" onclick="setUnknownCourse()" style="width:auto; padding:5px 10px;">ã‚³ãƒ¼ã‚¹ä¸æ˜</button>
    </div>
    <input type="hidden" id="course_id">
    
    <div class="range-wrap" style="margin-top:15px; border-top:1px solid #eee; padding-top:10px;">
      <label>çƒé€Ÿ: <span id="speed-disp" style="font-weight:bold;color:#007bff;">130</span> km/h</label>
      <input type="range" id="input-speed" min="60" max="170" value="130" oninput="document.getElementById('speed-disp').innerText=this.value">
      <div style="text-align:right;"><label><input type="checkbox" id="speed-unknown" onchange="toggleSpeed()"> ä¸æ˜</label></div>
    </div>
  </div>

  <div class="card">
    <label>çƒç¨®</label>
    <div class="btn-group" id="ball-type-group">
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ã‚«ãƒƒãƒˆãƒœãƒ¼ãƒ«</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ã‚«ãƒ¼ãƒ–</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ãƒ„ãƒ¼ã‚·ãƒ¼ãƒ </div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ã‚·ãƒ¥ãƒ¼ãƒˆ</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ãƒ•ã‚©ãƒ¼ã‚¯</div>
      <div class="btn-check" onclick="selectBtn('ball-type-group', this)">ãƒã‚§ãƒ³ã‚¸</div>
      <div class="btn-check btn-unknown" onclick="selectBtn('ball-type-group', this)">ä¸æ˜</div>
    </div>
  </div>

  <div class="card">
    <label>çµæœ</label>
    <div class="btn-group" id="result-group">
      <div class="btn-check" onclick="onResultSelect(this, false)">è¦‹é€ƒã—<br><span style="font-size:0.7rem">(ã‚¹ãƒˆãƒ©ã‚¤ã‚¯)</span></div>
      <div class="btn-check" onclick="onResultSelect(this, false)">ç©ºæŒ¯ã‚Š<br><span style="font-size:0.7rem">(ã‚¹ãƒˆãƒ©ã‚¤ã‚¯)</span></div>
      <div class="btn-check" onclick="onResultSelect(this, false)">ãƒœãƒ¼ãƒ«</div>
      <div class="btn-check" onclick="onResultSelect(this, false)" data-next="true">æ­»çƒ(å‡ºå¡)â€»</div>
      <div class="btn-check" onclick="onResultSelect(this, false)">ãƒ•ã‚¡ãƒ¼ãƒ«</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true">å®‰æ‰“â€»</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true">äºŒå¡æ‰“â€»</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true">ä¸‰å¡æ‰“â€»</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true">æœ¬å¡æ‰“â€»</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true" data-out="true">ã‚¢ã‚¦ãƒˆâ€»</div>
      <div class="btn-check" onclick="onResultSelect(this, true)" data-next="true" data-base="true">å¤±ç­–(å‡ºå¡)â€»</div>
      
      <div class="btn-check btn-special" onclick="onResultSelect(this, false)">ãƒ©ãƒ³ãƒŠãƒ¼æ­»<br>(1æ­»)</div>
      <div class="btn-check btn-special" onclick="onResultSelect(this, true)" data-double-play="true">ä½µæ®ºæ‰“<br>(2æ­»)</div>
      <div class="btn-check btn-special" onclick="onResultSelect(this, true)" data-triple-play="true">ä¸‰é‡æ®º<br>(3æ­»)</div>
      <div class="btn-check btn-unknown" onclick="onResultSelect(this, false)">ä¸æ˜</div>
    </div>
    
    <div id="hit-detail-area" class="hidden" style="margin-top:15px; border-top:2px dashed #ddd; padding-top:10px;">
      <label style="color:#d32f2f;">æ‰“çƒè©³ç´°</label>
      <div class="btn-group" id="hit-quality-group" style="margin-bottom:10px;">
        <div class="btn-check" onclick="selectBtn('hit-quality-group', this)">ã‚´ãƒ­</div>
        <div class="btn-check" onclick="selectBtn('hit-quality-group', this)">ãƒ•ãƒ©ã‚¤</div>
        <div class="btn-check" onclick="selectBtn('hit-quality-group', this)">ãƒ©ã‚¤ãƒŠãƒ¼</div>
        <div class="btn-check" onclick="selectBtn('hit-quality-group', this)">ãƒãƒ³ãƒˆ</div>
        <div class="btn-check btn-unknown" onclick="selectBtn('hit-quality-group', this)">ä¸æ˜</div>
      </div>
      <div id="field-container">
        <svg id="field-svg" viewBox="0 0 100 100" preserveAspectRatio="none">
          <path d="M 50,85 L 85,50 A 45,45 0 0,0 15,50 Z" fill="#ccb57e" />
          <line x1="50" y1="85" x2="0" y2="35" stroke="white" stroke-width="0.5" />
          <line x1="50" y1="85" x2="100" y2="35" stroke="white" stroke-width="0.5" />
          <path d="M 0,35 A 60,60 0 0,1 100,35" fill="none" stroke="white" stroke-width="1" />
          <rect x="42" y="70" width="16" height="16" transform="rotate(45 50 78)" fill="none" stroke="white" stroke-width="0.5" />
          <rect x="49" y="84" width="2" height="2" fill="white" />
          <rect x="73" y="60" width="2" height="2" fill="white" />
          <rect x="49" y="36" width="2" height="2" fill="white" />
          <rect x="25" y="60" width="2" height="2" fill="white" />
        </svg>
        <div id="hit-marker"></div>
      </div>
      <input type="hidden" id="hit_x"><input type="hidden" id="hit_y">
      </div>
  </div>

  <button id="submit-btn" onclick="recordBall()">ä¸€çƒè¨˜éŒ²</button>
  <button onclick="saveAndExit()" style="margin-top:10px; background:#6c757d; color:white; padding:8px; border:none; border-radius:4px;">ä¿å­˜ã—ã¦çµ‚äº†</button>
</div>

<script>
  const GAS_URL = "https://script.google.com/macros/s/AKfycbztZidK6NKz8jrTOeJkD6b07Qxn94sh2MsND3zOoiR8ViOl5Kn5XaI_tTxKPjwRLFO7/exec"; 
  const MY_TEAM = "æ±äº¬";
  const FIXED_TEAMS = ["æ±äº¬", "æ…¶æ‡‰", "æ—©ç¨²ç”°", "æ˜æ²»", "ç«‹æ•™", "æ³•æ”¿"];

  let ROSTER_CACHE = {};
  let dataBuffer = [];
  let isSending = false;
  let unknownPlayerCount = 1;
  
  let gameState = {
    gameId: "", matchName: "", inning: 1, isTop: true, outs: 0, balls: 0, strikes: 0,
    lineups: { top: [], bottom: [] }, pitchers: { top: "", bottom: "" }, batterIndex: { top: 0, bottom: 0 },
    teams: { top: "", bottom: "" }
  };

  window.onload = function() {
    initTeamSelects();
    createGrid();
    initFieldInput();
    window.addEventListener('beforeunload', function (e) {
      if (dataBuffer.length > 0 || isSending) { e.preventDefault(); e.returnValue = ''; }
    });
  };

  function showSetup() {
    document.getElementById('dashboard-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    const now = new Date();
    document.getElementById('input-game-id').value = "GAME-" + (now.getMonth()+1)+""+now.getDate()+"-"+now.getHours()+now.getMinutes();
  }

  function saveAndExit() {
    if (dataBuffer.length === 0 && !isSending) { location.reload(); return; }
    document.getElementById('loading-text').innerText = "ä¿å­˜ä¸­...";
    document.getElementById('loading-screen').style.display = 'flex';
    flushDataPromise().then(() => { alert("ä¿å­˜ã—ã¾ã—ãŸ"); location.reload(); });
  }
  function flushDataPromise() {
    return new Promise((resolve) => {
        if(dataBuffer.length === 0 && !isSending) { resolve(); return; }
        let check = setInterval(() => {
            if(dataBuffer.length === 0 && !isSending) { clearInterval(check); resolve(); }
        }, 500);
        flushData(); 
    });
  }

  // â– â– â–  ã‚¤ãƒ‹ãƒ³ã‚°ç§»å‹• (æ”¹è‰¯: 1ç•ªã€œ9ç•ªã‹ã‚‰é¸æŠ) â– â– â– 
  function openInningModal() {
    document.getElementById('inning-modal').classList.remove('hidden');
    updateInningModalPlayers();
  }

  function updateInningModalPlayers() {
    const tb = document.getElementById('edit-inning-tb').value;
    const isNextTop = (tb === "è¡¨");
    const attackTeamName = isNextTop ? gameState.teams.top : gameState.teams.bottom;
    const defenseTeamName = isNextTop ? gameState.teams.bottom : gameState.teams.top;
    
    // å®ˆå‚™å´(æŠ•æ‰‹)ã¯å…¨å“¡ã‹ã‚‰é¸ã¶
    const defRoster = ROSTER_CACHE[defenseTeamName];
    if (!defRoster) { alert("åç°¿ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚"); return; }
    
    const pSelect = document.getElementById('modal-inning-pitcher');
    pSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    defRoster.pitchers.forEach(p => pSelect.add(new Option(p, p)));

    // æ”»æ’ƒå´(æ‰“è€…)ã¯ã€Œç¾åœ¨ã®ãƒ©ã‚¤ãƒ³ãƒŠãƒƒãƒ—ã€ã‹ã‚‰é¸ã¶
    const bSelect = document.getElementById('modal-inning-batter');
    bSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
    const currentLineup = isNextTop ? gameState.lineups.top : gameState.lineups.bottom;
    
    currentLineup.forEach((name, idx) => {
        // valueã«ã¯æ‰“é †ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹(0-8)ã‚’å…¥ã‚Œã‚‹
        bSelect.add(new Option(`${idx+1}ç•ª: ${name}`, idx));
    });
  }

  function applyInningChange() {
    const pVal = document.getElementById('modal-inning-pitcher').value;
    const bIdxVal = document.getElementById('modal-inning-batter').value; // index (0-8)

    if (!pVal || bIdxVal === "") { alert("æŠ•æ‰‹ã¨æ‰“è€…ã‚’å¿…ãšé¸æŠã—ã¦ãã ã•ã„"); return; }

    gameState.inning = parseInt(document.getElementById('edit-inning-num').value);
    gameState.isTop = (document.getElementById('edit-inning-tb').value === "è¡¨");
    gameState.balls = 0; gameState.strikes = 0; gameState.outs = 0;

    const bIndex = parseInt(bIdxVal);

    if (gameState.isTop) {
      gameState.pitchers.bottom = pVal;
      gameState.batterIndex.top = bIndex;
      document.getElementById('current-batter').innerText = gameState.lineups.top[bIndex]; 
      document.getElementById('current-pitcher').innerText = pVal;
    } else {
      gameState.pitchers.top = pVal;
      gameState.batterIndex.bottom = bIndex;
      document.getElementById('current-batter').innerText = gameState.lineups.bottom[bIndex];
      document.getElementById('current-pitcher').innerText = pVal;
    }
    updateDisplay();
    document.getElementById('inning-modal').classList.add('hidden');
  }

  // â– â– â–  è¨˜éŒ²å‡¦ç† (V4.2æ”¹è‰¯) â– â– â– 
  function recordBall() {
    const ballTypeEl = document.querySelector('#ball-type-group .active');
    const resultEl = document.querySelector('#result-group .active');
    const courseId = document.getElementById('course_id').value;
    
    if (!resultEl) { alert("çµæœã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
    const resultText = resultEl.innerText;
    
    const isRunnerOut = resultText.includes("ãƒ©ãƒ³ãƒŠãƒ¼æ­»");
    if (!isRunnerOut) {
      if (!ballTypeEl || !courseId) { alert("çƒç¨®ãƒ»ã‚³ãƒ¼ã‚¹ãƒ»çµæœã¯å¿…é ˆã§ã™"); return; }
    }
    
    const isFoul = resultText.includes("ãƒ•ã‚¡ãƒ¼ãƒ«");
    const detailArea = document.getElementById('hit-detail-area');
    let hitQuality = ""; let hitX = ""; let hitY = "";
    
    // è©³ç´°å…¥åŠ›ã‚¹ã‚­ãƒƒãƒ—æ¡ä»¶: ãƒ•ã‚¡ãƒ¼ãƒ«ã€ãƒ©ãƒ³ãƒŠãƒ¼æ­»ã€ä½µæ®ºã€ä¸‰é‡æ®ºã€æ­»çƒ
    const skipDetail = isFoul || isRunnerOut || resultText.includes("ä½µæ®º") || resultText.includes("ä¸‰é‡æ®º") || resultText.includes("æ­»çƒ");

    if (!skipDetail && !detailArea.classList.contains('hidden')) {
      const qEl = document.querySelector('#hit-quality-group .active');
      hitX = document.getElementById('hit_x').value;
      
      if (!qEl) { alert("æ‰“çƒã®è³ªã‚’é¸æŠã—ã¦ãã ã•ã„"); return; }
      // ä¸æ˜ãªã‚‰åº§æ¨™ãªã—ã§ã‚‚OK
      if (qEl.innerText !== "ä¸æ˜" && !hitX) { alert("ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ç€å¼¾ç‚¹ã‚’æŒ‡å®šã—ã¦ãã ã•ã„"); return; }
      
      hitQuality = qEl.innerText; 
      hitY = document.getElementById('hit_y').value;
    }
    
    let speed = document.getElementById('speed-unknown').checked ? "ä¸æ˜" : document.getElementById('input-speed').value + "km/h";

    const oneBallData = {
      game_id: gameState.gameId, match_name: gameState.matchName, 
      pitcher: document.getElementById('current-pitcher').innerText,
      batter: document.getElementById('current-batter').innerText,
      inning: `${gameState.inning}${gameState.isTop ? 'è¡¨' : 'è£'}`,
      count: `${gameState.balls}-${gameState.strikes}`,
      ball_type: ballTypeEl ? ballTypeEl.innerText : "", 
      result: resultText.replace(/\r?\n/g, ''),
      course_x: courseId, course_y: 0,
      hit_quality: hitQuality, hit_x: hitX, hit_y: hitY,
      speed: speed
    };

    if (resultEl.classList.contains('btn-unknown')) {
      window.tempData = oneBallData; document.getElementById('unknown-modal').classList.remove('hidden'); return; 
    }
    processRecord(oneBallData, resultEl.innerText, resultEl.getAttribute('data-next') === 'true');
  }

  // â˜…åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ (æ­»çƒå¯¾å¿œ)
  function simulatePitch(rawResultText) {
    let result = rawResultText.replace(/(\r\n|\n|\r)/gm, "")
                              .replace('â€»', '')
                              .replace('(ã‚¹ãƒˆãƒ©ã‚¤ã‚¯)', '')
                              .replace('(å‡ºå¡)', '')
                              .replace('(1æ­»)', '')
                              .replace('(2æ­»)', '')
                              .replace('(3æ­»)', '');
    
    let next = false; let addOut = false;
    if (result === "ãƒœãƒ¼ãƒ«") { gameState.balls++; if (gameState.balls >= 4) next = true; } 
    else if (["è¦‹é€ƒã—","ç©ºæŒ¯ã‚Š","ãƒ•ã‚¡ãƒ¼ãƒ«"].includes(result)) {
      if (gameState.strikes < 2 || result !== "ãƒ•ã‚¡ãƒ¼ãƒ«") gameState.strikes++;
      if (gameState.strikes >= 3) { next = true; addOut = true; }
    } else if (["å››æ­»çƒ","æ­»çƒ","å®‰æ‰“","å¤±ç­–","ã‚¢ã‚¦ãƒˆ"].includes(result)) {
      next = true;
      if (result === "ã‚¢ã‚¦ãƒˆ") addOut = true;
    }
    if (addOut) gameState.outs++;
    if (next) {
      gameState.balls = 0; gameState.strikes = 0;
      if (gameState.outs >= 3) {
        gameState.outs = 0;
        if (!gameState.isTop) gameState.inning++;
        gameState.isTop = !gameState.isTop;
        setTimeout(() => alert("3ã‚¢ã‚¦ãƒˆ ãƒã‚§ãƒ³ã‚¸ï¼"), 100);
      }
    }
    return next;
  }

  // ä»¥ä¸‹ã€å…±é€šãƒ»æ—¢å­˜ãƒ­ã‚¸ãƒƒã‚¯
  function resolveUnknown(action) {
    const data = window.tempData;
    let resultTextForLogic = "";
    if (action === 'ball') resultTextForLogic = "ãƒœãƒ¼ãƒ«";
    else if (action === 'strike') resultTextForLogic = "è¦‹é€ƒã—"; 
    else if (action === 'foul') resultTextForLogic = "ãƒ•ã‚¡ãƒ¼ãƒ«";
    else if (action === 'out') resultTextForLogic = "ã‚¢ã‚¦ãƒˆ";
    else if (action === 'next') resultTextForLogic = "å®‰æ‰“"; 
    document.getElementById('unknown-modal').classList.add('hidden');
    processRecord(data, resultTextForLogic, false); 
  }
  function processRecord(data, resultText, isNextForce) {
    dataBuffer.push(data); updateNetworkStatus();
    const currentAttackingSide = gameState.isTop ? 'top' : 'bottom';
    let isNext = isNextForce;
    if (resultText !== "") { 
        // ç‰¹æ®Šçµæœå¯¾å¿œ
        const resText = cleanResult(resultText);
        let logicNext = false;
        if (resText.includes("ãƒ©ãƒ³ãƒŠãƒ¼æ­»")) {
           gameState.outs++; if (gameState.outs >= 3) logicNext = true; 
        } else if (resText.includes("ä½µæ®º")) {
           gameState.outs += 2; logicNext = true;
        } else if (resText.includes("ä¸‰é‡æ®º")) {
           gameState.outs += 3; logicNext = true;
        } else {
           logicNext = simulatePitch(resText);
        }
        if (logicNext) isNext = true; 
    }
    if (isNext) {
      if (gameState.outs >= 3) {
         gameState.outs = 0; if (!gameState.isTop) gameState.inning++; gameState.isTop = !gameState.isTop;
         alert("3ã‚¢ã‚¦ãƒˆ ãƒã‚§ãƒ³ã‚¸ï¼");
      } else {
         if (gameState.lineups[currentAttackingSide].length > 0) {
           gameState.batterIndex[currentAttackingSide] = (gameState.batterIndex[currentAttackingSide] + 1) % 9;
         }
      }
    }
    updateDisplay(); resetForm(); flushData();
  }
  function cleanResult(text) {
    return text.replace(/\r?\n/g, '').replace('â€»','').replace('(ã‚¹ãƒˆãƒ©ã‚¤ã‚¯)','').replace('(å‡ºå¡)','').replace('(1æ­»)','').replace('(2æ­»)','').replace('(3æ­»)','');
  }
  function resetForm() {
    document.getElementById('course_id').value = "";
    document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('selected'));
    for(let btn of document.getElementsByClassName('btn-check')) btn.classList.remove('active');
    document.getElementById('hit-detail-area').classList.add('hidden');
    document.getElementById('hit_x').value = ""; document.getElementById('hit_y').value = ""; document.getElementById('hit-marker').style.display = 'none';
  }
  function selectBtn(groupId, element) {
    const group = document.getElementById(groupId);
    for(let btn of group.getElementsByClassName('btn-check')) btn.classList.remove('active');
    element.classList.add('active');
  }
  function onResultSelect(element, isHit) {
    selectBtn('result-group', element);
    const detailArea = document.getElementById('hit-detail-area');
    const text = element.innerText;
    // è©³ç´°ä¸è¦: ãƒ•ã‚¡ãƒ¼ãƒ«, ãƒ©ãƒ³ãƒŠãƒ¼æ­», ä½µæ®º, ä¸‰é‡æ®º, æ­»çƒ
    const skip = text.includes("ãƒ•ã‚¡ãƒ¼ãƒ«") || text.includes("ãƒ©ãƒ³ãƒŠãƒ¼æ­»") ||  text.includes("æ­»çƒ");
    if(isHit && !skip) { detailArea.classList.remove('hidden'); } 
    else { 
      detailArea.classList.add('hidden'); 
      document.getElementById('hit_x').value = ""; document.getElementById('hit_y').value = ""; document.getElementById('hit-marker').style.display = 'none';
      const qGroup = document.getElementById('hit-quality-group');
      for(let btn of qGroup.getElementsByClassName('btn-check')) btn.classList.remove('active');
    }
  }
  function createGrid() {
    const container = document.getElementById('grid-container');
    for (let i = 1; i <= 25; i++) {
      const div = document.createElement('div'); div.className = 'grid-cell';
      if ([7,8,9, 12,13,14, 17,18,19].includes(i)) div.classList.add('strike-zone');
      div.onclick = function() {
        document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('selected'));
        div.classList.add('selected');
        document.getElementById('course_id').value = i;
      };
      container.appendChild(div);
    }
  }
  function initFieldInput() {
    const field = document.getElementById('field-container');
    const marker = document.getElementById('hit-marker');
    field.addEventListener('click', (e) => {
      const rect = field.getBoundingClientRect();
      const x = e.clientX - rect.left; const y = e.clientY - rect.top;
      document.getElementById('hit_x').value = Math.round((x / rect.width) * 100);
      document.getElementById('hit_y').value = Math.round((y / rect.height) * 100);
      marker.style.left = x + 'px'; marker.style.top = y + 'px'; marker.style.display = 'block';
    });
  }
  function flushData() {
    if (isSending || dataBuffer.length === 0) return;
    isSending = true; updateNetworkStatus();
    const dataToSend = [...dataBuffer]; dataBuffer = []; 
    fetch(GAS_URL, { method: 'POST', body: JSON.stringify(dataToSend), mode: 'no-cors' })
    .then(() => { isSending = false; if(dataBuffer.length>0) flushData(); else updateNetworkStatus(); })
    .catch(err => { isSending = false; dataBuffer = [...dataToSend, ...dataBuffer]; updateNetworkStatus(); setTimeout(flushData, 5000); });
  }
  function updateNetworkStatus() {
    const el = document.getElementById('network-status');
    let count = dataBuffer.length + (isSending ? 1 : 0);
    document.getElementById('unsent-count').innerText = count;
    el.style.display = count > 0 ? 'block' : 'none';
    el.style.background = isSending ? '#17a2b8' : '#ffc107';
  }
  function loadHistory() {
    const container = document.getElementById('game-list-container');
    container.innerHTML = '<div class="spinner"></div><div>å±¥æ­´å–å¾—ä¸­...</div>';
    fetch(`${GAS_URL}?type=init`)
      .then(res => res.json())
      .then(data => { renderGameList(data.games); })
      .catch(err => { container.innerHTML = 'å±¥æ­´å–å¾—ã‚¨ãƒ©ãƒ¼: ' + err; });
  }
  function renderGameList(games) {
    const list = document.getElementById('game-list-container'); list.innerHTML = "";
    if (games.length === 0) list.innerHTML = "<p>å±¥æ­´ãªã—</p>";
    games.forEach(g => {
      const div = document.createElement('div'); div.className = 'game-item';
      div.innerHTML = `<div><div style="font-weight:bold">${g.name}</div><div style="font-size:0.8rem;color:#888">${g.id}<br>${g.date}</div></div>
      <div><button class="btn-resume" onclick="viewGameLog('${g.id}')">é–²è¦§</button><button class="btn-resume" onclick="resumeGame('${g.id}')">å†é–‹</button><button class="btn-delete" onclick="deleteGame('${g.id}')">ğŸ—‘</button></div>`;
      list.appendChild(div);
    });
  }
  function resumeGame(gameId) {
    if(!confirm("å†é–‹ã—ã¾ã™ã‹ï¼Ÿ")) return;
    document.getElementById('loading-screen').style.display = 'flex';
    fetch(`${GAS_URL}?type=logs&game_id=${gameId}`).then(res=>res.json()).then(logs=>{
      if(logs.length===0){location.reload();return;}
      gameState.gameId = gameId; gameState.balls=0; gameState.strikes=0; gameState.outs=0;
      gameState.inning=1; gameState.isTop=true;
      gameState.lineups.top = []; gameState.lineups.bottom = [];
      for(let i=1; i<=9; i++) { gameState.lineups.top.push(i+"ç•ª(æœªå®š)"); gameState.lineups.bottom.push(i+"ç•ª(æœªå®š)"); }
      gameState.batterIndex.top = 0; gameState.batterIndex.bottom = 0;
      const lineupLog = logs.find(r => r[2] === "SYSTEM_LINEUP");
      let promises = [];
      if (lineupLog) {
        try {
          const lineupT = JSON.parse(lineupLog[3]); const lineupB = JSON.parse(lineupLog[4]);
          const ps = JSON.parse(lineupLog[5]); const matchInfo = JSON.parse(lineupLog[6] || "{}");
          gameState.lineups.top = lineupT; gameState.lineups.bottom = lineupB;
          gameState.pitchers.top = ps.topP; gameState.pitchers.bottom = ps.btmP;
          if(matchInfo.topTeam && matchInfo.btmTeam) {
             gameState.teams.top = matchInfo.topTeam; gameState.teams.bottom = matchInfo.btmTeam;
             const isPracT = (matchInfo.topTeam !== MY_TEAM); const isPracB = (matchInfo.btmTeam !== MY_TEAM);
             promises.push(fetch(`${GAS_URL}?type=roster&team=${matchInfo.topTeam}&is_practice=${isPracT}`).then(r=>r.json()).then(d=>ROSTER_CACHE[matchInfo.topTeam]=d));
             promises.push(fetch(`${GAS_URL}?type=roster&team=${matchInfo.btmTeam}&is_practice=${isPracB}`).then(r=>r.json()).then(d=>ROSTER_CACHE[matchInfo.btmTeam]=d));
          }
        } catch(e) { console.log(e); }
      }
      Promise.all(promises).then(() => {
        logs.forEach(r => {
          if(r[2] === "SYSTEM_LINEUP") return;
          const isTop = r[4].includes("è¡¨"); const side = isTop ? 'top' : 'bottom';
          if(r[3] && !r[3].includes("(æœªå®š)")) gameState.lineups[side][gameState.batterIndex[side]] = r[3];
          const defSide = isTop ? 'bottom' : 'top';
          if(r[2]) gameState.pitchers[defSide] = r[2];
          if(r[9] !== "ä¸æ˜") {
             const res = cleanResult(r[9]); let next = false; let addOut = false;
             if (res.includes("ãƒ©ãƒ³ãƒŠãƒ¼æ­»")) { gameState.outs++; if (gameState.outs >= 3) next = true; }
             else if (res.includes("ä½µæ®º")) { gameState.outs += 2; next = true; }
             else if (res.includes("ä¸‰é‡æ®º")) { gameState.outs += 3; next = true; }
             else { next = simulatePitch(res); }
             if(gameState.outs >= 3) { gameState.outs = 0; if(!gameState.isTop) gameState.inning++; gameState.isTop = !gameState.isTop; }
             else if(next) { gameState.batterIndex[side] = (gameState.batterIndex[side] + 1) % 9; }
          }
        });
        const last = logs[logs.length-1]; gameState.matchName = last[14] || ""; 
        updateDisplay(); document.getElementById('current-game-id').innerText = gameId;
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('dashboard-screen').classList.add('hidden');
        document.getElementById('game-screen').classList.remove('hidden');
      });
    });
  }
  function viewGameLog(gameId) {
    document.getElementById('loading-screen').style.display = 'flex';
    fetch(`${GAS_URL}?type=logs&game_id=${gameId}`).then(res => res.json()).then(logs => {
        document.getElementById('loading-screen').style.display = 'none';
        document.getElementById('viewer-modal').classList.remove('hidden');
        const cleanLogs = logs.filter(r => r[2] !== "SYSTEM_LINEUP");
        if (cleanLogs.length === 0) { document.getElementById('viewer-content').innerHTML = "<p style='text-align:center'>ãƒ‡ãƒ¼ã‚¿ãªã—</p>"; return; }
        const groups = groupLogsByAtBat(cleanLogs);
        document.getElementById('viewer-content').innerHTML = renderMatchDetail(groups);
    });
  }
  function groupLogsByAtBat(logs) {
    let groups = []; let currentGroup = { pitches: [], batter: "", pitcher: "", inning: "" };
    logs.forEach((row) => {
      const batter = row[3]; const inning = row[4];
      if (batter !== currentGroup.batter || inning !== currentGroup.inning) {
        if (currentGroup.pitches.length > 0) groups.push(currentGroup);
        currentGroup = { pitches: [], batter: batter, pitcher: row[2], inning: inning };
      }
      currentGroup.pitches.push(row);
    });
    if (currentGroup.pitches.length > 0) groups.push(currentGroup);
    return groups;
  }
  function renderMatchDetail(groups) {
    let html = "";
    groups.slice().reverse().forEach((g, i) => {
      const last = g.pitches[g.pitches.length - 1];
      const result = cleanResult(last[9]);
      const detail = (last[10] ? ` ${last[10]}` : "") + (last[11] ? " (æ‰“çƒ)" : "");
      let badgeClass = "result-badge";
      if (result.includes("å®‰æ‰“") || result.includes("å‡ºå¡") || result.includes("å››æ­»çƒ")) badgeClass += " hit";
      else if (result.includes("ã‚¢ã‚¦ãƒˆ") || result.includes("çŠ ") || result.includes("ä¸‰æŒ¯") || result.includes("ä½µæ®º")) badgeClass += " out";
      html += `<div class="log-group"><div class="log-summary" onclick="toggleDetail('detail-${i}')"><div><div style="font-size:0.8rem; color:#666;">${g.inning} - ${g.pitcher} vs</div><div class="batter-name">${g.batter}</div></div><div class="${badgeClass}">${result}${detail}</div></div><div id="detail-${i}" class="log-details">`;
      g.pitches.forEach((p, idx) => {
        const res = cleanResult(p[9]);
        html += `<div class="pitch-row"><span class="pitch-num">${idx+1}</span><span>${p[6]} ${p[13]||''}</span><span>${res}</span></div>`;
      });
      html += `</div></div>`;
    });
    return html;
  }
  window.toggleDetail = function(id) { document.getElementById(id).classList.toggle('open'); }
  function updateDisplay() {
    const sideText = gameState.isTop ? "è¡¨" : "è£";
    document.getElementById('status-inning').innerText = `${gameState.inning}å›${sideText}`;
    document.getElementById('disp-ball').innerText = gameState.balls;
    document.getElementById('disp-strike').innerText = gameState.strikes;
    document.getElementById('disp-out').innerText = gameState.outs;
    if(gameState.lineups.top.length > 0) {
      if (gameState.isTop) {
        document.getElementById('current-batter').innerText = gameState.lineups.top[gameState.batterIndex.top];
        if(gameState.pitchers.bottom) document.getElementById('current-pitcher').innerText = gameState.pitchers.bottom; 
      } else {
        document.getElementById('current-batter').innerText = gameState.lineups.bottom[gameState.batterIndex.bottom];
        if(gameState.pitchers.top) document.getElementById('current-pitcher').innerText = gameState.pitchers.top; 
      }
    }
  }
  function undoState() { gameState.balls = 0; gameState.strikes = 0; updateDisplay(); }
  function toggleMode() { initTeamSelects(); }
  function initTeamSelects() {
    const isPractice = document.getElementById('mode-practice').checked;
    const topArea = document.getElementById('top-selector-area');
    const btmArea = document.getElementById('bottom-selector-area');
    topArea.innerHTML = `<select id="team-top" onchange="onTeamSelect('top')"><option value="">é¸æŠ...</option></select>`;
    btmArea.innerHTML = `<select id="team-bottom" onchange="onTeamSelect('bottom')"><option value="">é¸æŠ...</option></select>`;
    const topSel = document.getElementById('team-top');
    const btmSel = document.getElementById('team-bottom');
    if (isPractice) {
      topSel.innerHTML = `<option value="${MY_TEAM}">${MY_TEAM}</option><option value="practice">ç›¸æ‰‹æ ¡(æ‰‹å…¥åŠ›)</option>`;
      btmSel.innerHTML = `<option value="${MY_TEAM}">${MY_TEAM}</option><option value="practice">ç›¸æ‰‹æ ¡(æ‰‹å…¥åŠ›)</option>`;
    } else {
      FIXED_TEAMS.forEach(team => { topSel.add(new Option(team, team)); btmSel.add(new Option(team, team)); });
    }
    onTeamSelect('top'); onTeamSelect('bottom');
  }
  function onTeamSelect(side) {
    let teamName = document.getElementById(`team-${side}`).value;
    const container = document.getElementById(`lineup-${side}-container`);
    container.innerHTML = "";
    if(!teamName) return;
    if (teamName === 'practice') {
      const inputId = `input-team-${side}`;
      if(!document.getElementById(inputId)) {
        document.getElementById(`team-${side}`).parentElement.innerHTML += `<input type="text" id="${inputId}" placeholder="ç›¸æ‰‹æ ¡å" onblur="fetchPracticeRoster('${side}')" style="margin-top:5px;">`;
      }
      return; 
    }
    const isPractice = (teamName === MY_TEAM) ? false : document.getElementById('mode-practice').checked;
    fetchRoster(side, teamName, isPractice);
  }
  function fetchPracticeRoster(side) {
    const teamName = document.getElementById(`input-team-${side}`).value;
    if(!teamName) return; fetchRoster(side, teamName, true);
  }
  function fetchRoster(side, teamName, isPractice) {
    const container = document.getElementById(`lineup-${side}-container`);
    if (ROSTER_CACHE[teamName]) { renderLineupUI(side, teamName); } 
    else {
      container.innerHTML = `<div class="loading-mini">åç°¿å–å¾—ä¸­...</div>`;
      fetch(`${GAS_URL}?type=roster&team=${teamName}&is_practice=${isPractice}`)
        .then(res => res.json()).then(data => { ROSTER_CACHE[teamName] = data; renderLineupUI(side, teamName); });
    }
  }
  function renderLineupUI(side, teamName) {
    const container = document.getElementById(`lineup-${side}-container`);
    const data = ROSTER_CACHE[teamName];
    const allPlayers = [...data.pitchers, ...data.fielders]; 
    const unknownOpt = `<option value="NEW_PLAYER">ï¼‹ é¸æ‰‹ã‚’è¿½åŠ (ä¸æ˜)</option>`;
    const lastLineup = data.lastLineup || [];
    let defaultP = data.lastPitcher || "";
    let html = `<label>${teamName} æŠ•æ‰‹</label><select id="pitcher-${side}" style="margin-bottom:5px;" onchange="checkNewPlayer(this, '${teamName}', 'pitchers')">${unknownOpt}`;
    data.pitchers.forEach(p => { const sel = (p === defaultP) ? "selected" : ""; html += `<option value="${p}" ${sel}>${p}</option>`; });
    html += `</select>`;
    for(let i=0; i<9; i++) {
      let defaultSel = "";
      if(lastLineup.length > i) defaultSel = lastLineup[lastLineup.length - 1 - i]; 
      html += `<select id="batter-${side}-${i}" style="margin-bottom:2px; font-size:0.85rem;" onchange="checkNewPlayer(this, '${teamName}', 'fielders')">
        <option value="">é¸æŠ...</option>${unknownOpt}`;
      allPlayers.forEach(p => { const selected = (p === defaultSel) ? "selected" : ""; html += `<option value="${p}" ${selected}>${p}</option>`; });
      html += `</select>`;
    }
    container.innerHTML = html;
  }
  function checkNewPlayer(selectElem, teamName, role) {
    if (selectElem.value === "NEW_PLAYER") {
      const newName = "ä¸æ˜" + (unknownPlayerCount++);
      ROSTER_CACHE[teamName][role].push(newName);
      const opt = new Option(newName, newName);
      selectElem.add(opt, selectElem.options[1]);
      selectElem.value = newName;
    }
  }
  function deleteGame(gameId) {
    if(!confirm(`Game ID: ${gameId}\nå‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
    document.getElementById('loading-screen').style.display = 'flex';
    fetch(GAS_URL, { method: 'POST', body: JSON.stringify({ action: 'delete', game_id: gameId }) })
    .then(res => res.json()).then(data => { alert("å‰Šé™¤ã—ã¾ã—ãŸ"); location.reload(); })
    .catch(err => { alert("å‰Šé™¤ã‚¨ãƒ©ãƒ¼: " + err); location.reload(); });
  }
  function setUnknownCourse() {
    document.querySelectorAll('.grid-cell').forEach(c => c.classList.remove('selected'));
    document.getElementById('course_id').value = "ä¸æ˜";
    alert("ã‚³ãƒ¼ã‚¹: ä¸æ˜");
  }
  function toggleSpeed() {
    const chk = document.getElementById('speed-unknown');
    document.getElementById('input-speed').disabled = chk.checked;
    document.getElementById('speed-disp').innerText = chk.checked ? "ä¸æ˜" : document.getElementById('input-speed').value;
  }
  function applyPitcherChange() {
    const newPitcher = document.getElementById('sub-pitcher-select').value;
    if(newPitcher==="NEW_PLAYER") return;
    const defenseSide = gameState.isTop ? 'bottom' : 'top';
    gameState.pitchers[defenseSide] = newPitcher;
    document.getElementById('current-pitcher').innerText = newPitcher;
    document.getElementById('sub-modal').classList.add('hidden');
  }
  function applyBatterChange() {
    const newBatter = document.getElementById('sub-batter-select').value;
    if(newBatter==="NEW_PLAYER") return;
    const attackSide = gameState.isTop ? 'top' : 'bottom';
    gameState.lineups[attackSide][gameState.batterIndex[attackSide]] = newBatter;
    document.getElementById('current-batter').innerText = newBatter;
    document.getElementById('sub-modal').classList.add('hidden');
  }
  function startGame() {
    const isPractice = document.getElementById('mode-practice').checked;
    let topTeam = document.getElementById('team-top').value;
    let btmTeam = document.getElementById('team-bottom').value;
    if (topTeam === 'practice') topTeam = document.getElementById('input-team-top').value;
    if (btmTeam === 'practice') btmTeam = document.getElementById('input-team-bottom').value;
    if(!topTeam || !btmTeam) { alert("ãƒãƒ¼ãƒ åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    gameState.gameId = document.getElementById('input-game-id').value;
    gameState.matchName = document.getElementById('input-match-name').value;
    gameState.teams.top = topTeam; gameState.teams.bottom = btmTeam;
    gameState.pitchers.top = document.getElementById('pitcher-top').value;
    gameState.pitchers.bottom = document.getElementById('pitcher-bottom').value;
    gameState.lineups.top = []; gameState.lineups.bottom = [];
    for(let i=0; i<9; i++) {
      gameState.lineups.top.push(document.getElementById(`batter-top-${i}`).value);
      gameState.lineups.bottom.push(document.getElementById(`batter-bottom-${i}`).value);
    }
    const lineupData = {
      game_id: gameState.gameId, match_name: gameState.matchName,
      pitcher: "SYSTEM_LINEUP", 
      batter: JSON.stringify(gameState.lineups.top), 
      inning: JSON.stringify(gameState.lineups.bottom), 
      count: JSON.stringify({ topP: gameState.pitchers.top, btmP: gameState.pitchers.bottom, topTeam: topTeam, btmTeam: btmTeam }),
      result: "GAME_START"
    };
    dataBuffer.push(lineupData); flushData(); 
    document.getElementById('setup-screen').classList.add('hidden');
    document.getElementById('game-screen').classList.remove('hidden');
    document.getElementById('current-game-id').innerText = gameState.gameId;
    updateDisplay();
  }
  function showSetup() {
    document.getElementById('dashboard-screen').classList.add('hidden');
    document.getElementById('setup-screen').classList.remove('hidden');
    const now = new Date();
    document.getElementById('input-game-id').value = "GAME-" + (now.getMonth()+1)+""+now.getDate()+"-"+now.getHours()+now.getMinutes();
  }
</script>
</body>
</html>
